{% extends "apps/layouts/base.html" %}
{% load static %}
<head>
    <!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<!-- Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
</head>
{% block content %}
<div class="voyage-single-container" style="display: flex; gap: 40px; padding: 20px;">

    <!-- Colonne gauche -->
    <div class="left-column" style="flex: 1; max-width: 350px;">
        <div class="conducteur-card" style="border: 1px solid #ddd; border-radius: 10px; padding: 20px; text-align: center;">
            {% if voyage.conducteur.profilutilisateur.photo_profil %}
                <img src="{{ voyage.conducteur.profilutilisateur.photo_profil.url }}" 
                     alt="{{ voyage.conducteur.username }}" 
                     style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px;">
            {% endif %}
            <h3>{{ voyage.conducteur.username }}</h3>
            {% if voyage.conducteur.profilutilisateur.bio %}
                <p>{{ voyage.conducteur.profilutilisateur.bio }}</p>
            {% endif %}

            <div class="note-moyenne" style="margin-top:10px;">
                {% if moyenne_avis %}
                    <p><strong>Note moyenne :</strong> {{ moyenne_avis|floatformat:1 }} / 5 ⭐
                        — <a href="{% url 'apps:conducteur_avis' voyage.conducteur.id %}">Voir tous les avis</a>
                    </p>
                {% else %}
                    <p>Aucun avis — <a href="{% url 'apps:conducteur_avis' voyage.conducteur.id %}">Voir les avis</a></p>
                {% endif %}
            </div>
        </div>

        {% if voyage.conducteur.voitures.exists %}
        <div class="voiture-card" style="border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin-top: 20px; text-align: center;">
            {% with voiture=voyage.conducteur.voitures.first %}
                {% if voiture.photo %}
                    <img src="{{ voiture.photo.url }}" alt="{{ voiture.marque }} {{ voiture.modele }}" 
                         style="width: 100%; border-radius: 10px; object-fit: cover; margin-bottom: 10px;">
                {% endif %}
                <h4>{{ voiture.marque }} {{ voiture.modele }}</h4>
                <p>Immatriculation : {{ voiture.immatriculation }}</p>
                <p>Places : {{ voiture.nombre_places }}</p>
                {% if voiture.couleur %}<p>Couleur : {{ voiture.couleur }}</p>{% endif %}
            {% endwith %}
        </div>
        {% endif %}
    </div>

    <!-- Colonne droite -->
    <div class="right-column" style="flex: 2; display: flex; flex-direction: column; gap: 20px;">

        <div class="voyage-details" style="border: 1px solid #ddd; border-radius: 10px; padding: 30px;">
            <h2>{{ voyage.titre }}</h2>
            <p><strong>Départ :</strong> {{ voyage.depart }}</p>
            <p><strong>Arrivée :</strong> {{ voyage.arrivee }}</p>
            <p><strong>Date :</strong> {{ voyage.date_depart|date:"d/m/Y H:i" }}</p>
            <p><strong>Places restantes :</strong> {{ voyage.nb_places_restantes }}</p>
            <p><strong>Prix :</strong> {{ voyage.prix }} €</p>
            <p><strong>Écologique :</strong> {% if voyage.ecologique %}Oui{% else %}Non{% endif %}</p>
            <p><strong>État :</strong> {{ voyage.get_etat_display }}</p>
            <p>{{ voyage.description }}</p>

            <form method="post" action="{% url 'apps:reserver_voyage' voyage.id %}">
                {% csrf_token %}
                <button type="submit" style="background-color: #007BFF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Réserver
                </button>
            </form>
        </div>

        <!-- Carte -->
        
{% if coords_depart and coords_arrivee %}
<div style="width: 100%;">
    <div id="map" style="width: 100%; height: 400px; border-radius: 10px; overflow: hidden;"></div>

    <div style="margin-top: 10px; font-size: 1.1em; text-align: center;">
        <p><strong>Distance :</strong> {{ distance_km }} km</p>
        <p><strong>Durée estimée :</strong> {{ duree_h }} h</p>
    </div>
</div>
{% endif %}
    </div>
</div>

<!-- Leaflet -->
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<!-- Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
{% if coords_depart and coords_arrivee %}
    var map = L.map('map').setView([{{ coords_depart.0 }}, {{ coords_depart.1 }}], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marqueurs
    var depart = L.marker([{{ coords_depart.0 }}, {{ coords_depart.1 }}]).addTo(map)
        .bindPopup("Départ : {{ voyage.depart }}");
    var arrivee = L.marker([{{ coords_arrivee.0 }}, {{ coords_arrivee.1 }}]).addTo(map)
        .bindPopup("Arrivée : {{ voyage.arrivee }}");

    // Tracé de l’itinéraire
    L.Routing.control({
        waypoints: [
            L.latLng({{ coords_depart.0 }}, {{ coords_depart.1 }}),
            L.latLng({{ coords_arrivee.0 }}, {{ coords_arrivee.1 }})
        ],
        lineOptions: {
            styles: [{ color: 'blue', weight: 4 }]
        },
        createMarker: function() { return null; }, // On garde seulement tes marqueurs persos
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true
    }).addTo(map);
{% endif %}
</script>

{% endblock %}

